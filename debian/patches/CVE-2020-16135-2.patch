From dbfb7f44aa905a7103bdde9a198c1e9b0f480c2e Mon Sep 17 00:00:00 2001
From: Andreas Schneider <asn@cryptomilk.org>
Date: Wed, 3 Jun 2020 10:05:51 +0200
Subject: [PATCH] sftpserver: Add missing return check for
 ssh_buffer_add_data()

Signed-off-by: Andreas Schneider <asn@cryptomilk.org>

---
 src/sftpserver.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/sftpserver.c b/src/sftpserver.c
index 6de253a..1bc0051 100644
--- a/src/sftpserver.c
+++ b/src/sftpserver.c
@@ -43,6 +43,7 @@ sftp_client_message sftp_get_client_message(sftp_session sftp) {
   sftp_client_message msg;
   ssh_buffer payload;
   ssh_string tmp;
+  int rc;
 
   msg = malloc(sizeof (struct sftp_client_message_struct));
   if (msg == NULL) {
@@ -70,7 +71,12 @@ sftp_client_message sftp_get_client_message(sftp_session sftp) {
       return NULL;
   }
 
-  buffer_add_data(msg->complete_message, buffer_get_rest(payload), buffer_get_rest_len(payload));
+  rc = buffer_add_data(msg->complete_message, buffer_get_rest(payload), buffer_get_rest_len(payload));
+  if (rc < 0) {
+      ssh_set_error_oom(session);
+      sftp_client_message_free(msg);
+      return NULL;
+  }
 
   buffer_get_u32(payload, &msg->id);
 
-- 
2.25.1

