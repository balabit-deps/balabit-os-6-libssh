From b5b9ae012501dbc4fc64442714e5612eed5e8841 Mon Sep 17 00:00:00 2001
From: Anderson Toshiyuki Sasaki <ansasaki@redhat.com>
Date: Wed, 19 Sep 2018 14:23:35 +0200
Subject: [PATCH 4/8] CVE-2018-10933: Set correct state after sending MIC

After sending the client token, the auth state is set as
SSH_AUTH_STATE_GSSAPI_MIC_SENT.  Then this can be expected to be the
state when a USERAUTH_FAILURE or USERAUTH_SUCCESS arrives.

Fixes T101

Signed-off-by: Anderson Toshiyuki Sasaki <ansasaki@redhat.com>
---
 src/gssapi.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: libssh-0.6.3/src/gssapi.c
===================================================================
--- libssh-0.6.3.orig/src/gssapi.c	2018-10-16 15:04:52.412197665 -0400
+++ libssh-0.6.3/src/gssapi.c	2018-10-16 15:04:52.412197665 -0400
@@ -953,8 +953,8 @@ SSH_PACKET_CALLBACK(ssh_packet_userauth_
         ssh_string_free(token);
     }
     if(maj_stat == GSS_S_COMPLETE){
-        session->auth_state = SSH_AUTH_STATE_NONE;
         ssh_gssapi_send_mic(session);
+        session->auth_state = SSH_AUTH_STATE_GSSAPI_MIC_SENT;
     }
     return SSH_PACKET_USED;
 }
